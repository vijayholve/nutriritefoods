var interval;
jQuery(document).on("input", ".otp_input",function(){
	enableValidateBtn(this);
});

jQuery(document).on('keypress', '.otp_input,.otp-number', function (e) {
    if (e.which == 13) e.preventDefault();
	var maxlength = jQuery(this).attr("max");
	
	if(jQuery(this).val().length==maxlength)
	{
		if(event.which){
			event.preventDefault();
		}
	}
});

if(typeof sa_otp_settings !=  'undefined' && sa_otp_settings['login_with_otp']==true)
{
	if(sa_otp_settings['hide_default_login_form'] == 'on')
	{
		
		jQuery(document).ready(function(){
			add_login_with_otp();
			jQuery(".sa_myaccount_btn").trigger("click");
			jQuery(".sa_default_login_form").hide();
		});
	}
	else
	{
		jQuery( window ).on("load",function() {
			add_login_with_otp();
		});
	}
}

function add_login_with_otp()
{
	var parentForm =  jQuery(".sa_myaccount_btn").closest("form");
	
	parentForm.find('#rememberme').closest('label').each(function () {
		var form = jQuery(this).closest('form');
		form.find('.woocommerce-LostPassword').prepend(jQuery(this));
	});
	jQuery.each(parentForm,function(index,item){
		if(typeof sa_otp_settings  != 'undefined' && sa_otp_settings['show_countrycode']=='on')
		{
			jQuery(".sa-lwo-form-holder").find('.phone-valid').intlTelInput("destroy");
		}
		var login_with_otp_form = jQuery(".sa-lwo-form-holder").html();
		jQuery('<form class="sa-lwo-form woocommerce-form woocommerce-form-login login" method="post"></form>').insertAfter( jQuery(item).not(".saParentForm"));
		jQuery(item).addClass("saParentForm");
		//jQuery(item).next(".sa-lwo-form").hide().html(login_with_otp_form).css({"padding":"10px"});
		jQuery(item).next(".sa-lwo-form").html(login_with_otp_form).attr('style',"padding:10px;display:none!important");
		
	});
	jQuery(".sa-lwo-form-holder").remove();
}

if(
	(typeof sa_otp_settings  != 'undefined' && sa_otp_settings['is_checkout']) && 
	((typeof sa_otp_settings !=  'undefined' && sa_otp_settings['login_with_otp']) ||
	 (typeof sa_otp_settings !=  'undefined' && sa_otp_settings['buyer_login_otp'])	
	)
)
{
	jQuery(".showlogin").parents(".woocommerce-info").hide();

	var parentForm =  jQuery(".showlogin").parents(".woocommerce-info");

	var content = jQuery(".showlogin").parents(".woocommerce-info").clone();	
		
	var child_div = jQuery(".showlogin").parents(".woocommerce-info").after(content);

	child_div.show();
	child_div.find('.showlogin').addClass("sa-showlogin").removeClass("showlogin");

	jQuery(document).on("click",".sa-showlogin",function(){
		
		if(sa_otp_settings['hide_default_login_form'] == 'on')
		{
			jQuery(".sa-lwo-form").toggle();
		}
		else
		{			
			if(jQuery(this).hasClass("lwo-opened"))
			{
				jQuery(".sa-lwo-form").hide();
				jQuery(".woocommerce-form-login").hide();
				jQuery(this).removeClass("lwo-opened");
			}
			else
			{
				jQuery(".woocommerce-form-login").not('.sa-lwo-form').toggle();
				jQuery(this).addClass("lwo-opened");
			}
		}
		return false;
	});
}

jQuery(document).on("click",".register .sa-otp-btn-init",function(){
	var current_form = jQuery(this).parents("form");
	var data = current_form.serialize()+"&register=Register";
	var action_url = sa_otp_settings['site_url']+"/?option=smsalert_register_with_otp";
	saInitOTPProcess(
		this,
		action_url,
		data,
		sa_otp_settings['otp_time'],
		function(resp){
		},
		function(){
			current_form.submit()
		}

	);
	return false;
});

jQuery(document).on("click",".register .smsalert_otp_validate_submit",function(){	
	var current_form = jQuery(this).parents("form");
	var action_url = sa_otp_settings['site_url']+"/?option=smsalert-validate-otp-form";
	var data = current_form.serialize()+"&otp_type=phone&from_both=&register=Register";
	sa_validateOTP(this,action_url,data,function(){
		current_form.submit()
	});

	return false;
});


jQuery(document).on("click",".sa-lwo-form .sa-otp-btn-init",function(){
	
	var mob_field = jQuery(this).parents("form").find("[name=username]");
	mob_field.next(".sa_phone_error").text("");
	if(mob_field.val()=='')
	{
		var enter_mob_no 	= (typeof sa_notices !=  'undefined' && sa_notices['enter_mob_no']) ? sa_notices['enter_mob_no'] : "";jQuery(".sa-lwo-form .sa_phone_error").html(enter_mob_no).fadeIn().css({"color":"red"});
		return;
	}
	
	jQuery(this).parents(".smsalertModal").hide();
	var data = jQuery(this).parents("form").serialize()+"&login=Login";
	var action_url = sa_otp_settings['site_url']+"/?option=smsalert_ajax_login_with_otp";
	saInitOTPProcess(this,action_url, data,sa_otp_settings['otp_time']);
});

jQuery(document).on("click",".sa_default_login_form",function(){
	jQuery(".sa_myaccount_btn").parents("form").fadeIn(1000,'linear');
	jQuery(this).parents("form").attr("style","padding:10px;display:none!important");
	jQuery(this).parents("form").find(".phone-valid").val("");
});	

jQuery(document).on("click",".smsalert_login_popup.sa-otp-btn-init, .sa_popup .smsalert_login_popup.sa-otp-btn-init",function(){
	jQuery(this).parents(".smsalertModal").hide();
	var data = jQuery(this).parents("form").serialize()+"&login=Login";
	var action_url = sa_otp_settings['site_url']+"/?option=smsalert_ajax_login_popup";
	saInitOTPProcess(this,action_url, data,sa_otp_settings['otp_time']);
});

jQuery(document).on("click",".woocommerce-form-login .smsalert_otp_validate_submit, .sa_popup .smsalert_otp_validate_submit, .sa-lwo-form .smsalert_otp_validate_submit",function(){
	var current_form 	= jQuery(this).parents("form");
	var action_url 		= sa_otp_settings['site_url']+"/?option=smsalert-validate-otp-form";
	var data = current_form.serialize()+"&otp_type=phone&from_both=&login=Login";
	sa_validateOTP(this,action_url,data,function(){
		current_form.find(".login_with_otp_extra_fields").html("<input type=\"hidden\" name=\"login\" value=\"Login\">"),	
		((current_form.find(".sa_mobileno").length>0) ? submitLoginWithOTPForm(current_form) : current_form.submit())				
	});
	return false;		   
});

function submitLoginWithOTPForm(parent_form)
{
	$sa.ajax({
		url:sa_otp_settings.site_url+"/?option=smsalert_verify_login_with_otp",type:"POST",
		data:parent_form.serialize(),
		crossDomain:!0,
		dataType:"json",
		success:function(o){("success"==o.result && o.message=="Login successful")?
		(window.location.href=o.redirect):
		(
		current_form.find(".blockUI").hide(),
		current_form.find("#smsalert_login_message").empty().addClass("woocommerce-error"),
		current_form.find("#smsalert_login_message").append(o.message),
		current_form.find("#smsalert_login_message").removeClass("woocommerce-message"),
		current_form.find("#smsalert_login_customer_validation_otp_token").focus())
		},
		error:function(o,e,m)
		{
			alert("error found here");
		}
	});
	return false;
}

jQuery(document).on("click", ".sa_myaccount_btn",function(){
	var parentForm =  jQuery(this).parents("form");
	parentForm.attr("style", "display: none !important");
	if(sa_otp_settings['show_countrycode']=='on')
	{
		var default_cc = (typeof sa_default_countrycode !='undefined' && sa_default_countrycode!='') ? sa_default_countrycode : '91';
		var show_default_cc = '';
		parentForm.next(".sa-lwo-form").fadeIn(1000,'linear',function(){
		var mob_field = jQuery(this).find('.phone-valid');
		mob_field.intlTelInput("destroy");
		
		var object = jQuery(this).saIntellinput({hiddenInput:"username"});
		
		var iti = mob_field.intlTelInput(object);
		if(default_cc!='')
		{
			var selected_cc = getCountryByCode(default_cc);
			var show_default_cc = selected_cc[0].iso2.toUpperCase();
			iti.intlTelInput("setCountry",show_default_cc);
		}
			
		jQuery(".sa_mobileno").keyup(function(){
			var fullnumber =  jQuery(this).intlTelInput("getNumber"); //get number with std code
			jQuery(this).next("[name=username]").val(fullnumber);
		});
			
		mob_field.focus();	
			
		});
		parentForm.next(".sa-lwo-form").addClass("lwo-opened");
		
		
	}
	else
	{
		parentForm.next(".sa-lwo-form").fadeIn(1000,'linear',function(){
			var mob_field = jQuery(this).find('.phone-valid');
			mob_field.focus();
		});
		jQuery(this).parents(".woocommerce").find(".sa-showlogin").addClass("lwo-opened");
	
		
	}
	
});

//get all country data		
function getCountryByCode(code) {
	return window.intlTelInputGlobals.getCountryData().filter(
	function(data){ return (data.dialCode == code) ? data.iso2 : ''; }
	);
}

function enableValidateBtn(obj,otp_length=0)
{
	if(jQuery(obj).val().match(/^\d{4,8}$/)) {
		jQuery(".smsalert_otp_validate_submit,obj").removeAttr("style");
		jQuery(".smsalert_otp_validate_submit,obj").removeAttr("disabled");	
	}
	else
	{
		jQuery(".smsalert_otp_validate_submit,obj").css({"color":"grey","pointer-events":"none"});
	}
}

function saResendOTP(obj)
{
	jQuery(obj).text('re-sending..');
	jQuery(obj).parents("form").find(".sa-otp-btn-init").trigger("click");
	return false;
}

function sa_otp_timer(obj,otp_timer=15)
{
	var timer = function(secs){
		var sec_num = parseInt(secs, 10)    
		var hours   = Math.floor(sec_num / 3600) % 24
		var minutes = Math.floor(sec_num / 60) % 60
		var seconds = sec_num % 60    
		hours = hours < 10 ? "0" + hours : hours;
		minutes = minutes < 10 ? "0" + minutes : minutes;
		seconds = seconds < 10 ? "0" + seconds : seconds;
		return [hours,minutes,seconds].join(":")
	};
	obj.find(".sa_timer").show();
	obj.find(".sa_forgot").hide();//23/06								   
	obj.find(".sa_timer").html(timer(otp_timer)+" sec");
	obj.find(".sa_resend_btn").text("Resend");
	var counter = otp_timer;
	 interval = setInterval(function() {
		counter--;
		var places = (counter < 10 ? "0" : "");
		obj.find(".sa_timer").html(timer(counter)+" sec");
		if (counter == 0) 
		{
			counterRunning=false;
			obj.find(".sa_timer").hide();
			obj.find(".sa_forgot").show(); // 23/06												   
			var cssString = "pointer-events: auto; cursor: pointer; opacity: 1; float:right"; 
			obj.find(".sa_resend_btn").attr("style",cssString);
			clearInterval(interval);
		}
		else
		{
			var cssString = "pointer-events: none; cursor: default; opacity: 1; float:right";
			obj.find(".sa_resend_btn").attr("style",cssString);
		}
	}, 1000);
}

jQuery(document).on("click", ".close",function(){
	clearInterval(interval);
	//var button_txt = jQuery(".sa-otp-btn-init").attr("data-button");
	//jQuery(".sa-otp-btn-init").removeClass('check');
	//jQuery(this).parents(".smsalertModal").hide();
	jQuery(".blockUI").hide();
	var modal_style = jQuery(this).parents().find('.smsalertModal').attr('data-modal-close');
	jQuery(this).parents().find('.smsalertModal').addClass(modal_style+'Out');
    jQuery(this).parents(".smsalertModal").hide('slow');
	setTimeout(function() {
		//jQuery('.modal-content').removeClass(modal_style+'Out');
		jQuery('.smsalertModal').removeClass(modal_style+'Out');
	}, 500);
});

function saInitOTPProcess(obj,action_url, data_obj,otp_resend_timer=15,success_cb=null,failure_cb=null)
{
	var waiting_txt 	= (typeof sa_notices !=  'undefined' && sa_notices['waiting_txt']) ? sa_notices['waiting_txt'] : "Please Wait...";			
	var counterRunning	= false;
	var cur_btn 	   	= jQuery(obj);
	var prev_btn_text 	= cur_btn.val();
	
	var wpml_lang 		= (typeof smsalert_wpml !=  'undefined' && smsalert_wpml['lang']) ? smsalert_wpml['lang'] : "";
	if(cur_btn.is("input")){
		cur_btn.val(waiting_txt).attr("disabled",true);
		
	}else{
		cur_btn.addClass('button--loading').attr("disabled",true);
	}
	var currentModel 	= jQuery(obj).parents("form").find(".smsalertModal");
	if(counterRunning){currentModel.show();return false;}
	   
	$sa = jQuery;
	var current_form = $sa(obj).parents("form"); 
	$sa.ajax({
		url:action_url+"&lang="+wpml_lang,
		type:"POST",
		data:data_obj,
		crossDomain:!0,
		dataType:"json",
		success:function(o){
		("success"==o.result)?(
		(cur_btn.is("input") ? cur_btn.val(prev_btn_text).attr("disabled",false) : cur_btn.removeClass('button--loading').attr("disabled",false)),
		currentModel.find(".otp_input").val(""),
		currentModel.find(".otp-number").val(""),
		currentModel.find(".sa-message").empty().removeClass("woocommerce-error"),
		currentModel.find(".sa-message").append(o.message),
		currentModel.find(".sa-message").addClass("woocommerce-message"),
		currentModel.show(), 
		currentModel.find(".smsalert_validate_field").show(),
		sa_otp_timer(currentModel,otp_resend_timer),
		counterRunning=true,
		((typeof success_cb == "function") ? success_cb(o) : "" )
		):
		(
		currentModel.find(".smsalert_validate_field").hide(),
		currentModel.find(".sa-message").empty(),
		currentModel.find(".sa-message").append(o.message),
		currentModel.find(".sa-message").addClass("woocommerce-error"),
		currentModel.show(),
		(cur_btn.is("input") ? cur_btn.val(prev_btn_text).attr("disabled",false) : cur_btn.removeClass('button--loading').attr("disabled",false))
		)
		
		},
		error:function(o,e,m)
		{
			cur_btn.val(prev_btn_text).attr("disabled",false);
			cur_btn.removeClass('check').attr("disabled",false);
			((typeof failure_cb == "function") ? failure_cb(o) : "" )
		}
	});		   
	return false;
}

function saInitBlockOTPProcess(obj,action_url, data_obj,otp_resend_timer=15,success_cb=null,failure_cb=null)
{
	var waiting_txt 	= (typeof sa_notices !=  'undefined' && sa_notices['waiting_txt']) ? sa_notices['waiting_txt'] : "Please wait...";	
	var counterRunning	=false;
	var cur_btn 	   	= jQuery(obj);
	var prev_btn_text 	= cur_btn.val();	
	var wpml_lang 		= (typeof smsalert_wpml !=  'undefined' && smsalert_wpml['lang']) ? smsalert_wpml['lang'] : "";			
	
	if(cur_btn.is("input")){
		cur_btn.val(waiting_txt).attr("disabled",true);
	
	}else{
		cur_btn.addClass('button--loading').attr("disabled",true);
	}
	var currentModel 	= jQuery(obj).parents(".entry-content").find(".smsalertModal"); 
	//var currentModel 	= jQuery(obj).parents(".entry-content").find('.smsalertModal'); 
	if(counterRunning){currentModel.show();return false;}

	$sa = jQuery;
	var current_form = $sa(obj).parents("form"); 
	$sa.ajax({
		url:action_url+"&lang="+wpml_lang,
		type:"POST",
		data:data_obj,
		crossDomain:!0,
		dataType:"json",
		success:function(o){
		("success"==o.result)?(
		
			(cur_btn.is("input") ? cur_btn.val(prev_btn_text).attr("disabled",false) : cur_btn.removeClass('button--loading').attr("disabled",false)),
		currentModel.find(".otp_input").val(""),
		currentModel.find(".otp-number").val(""),
		currentModel.find(".sa-message").empty().removeClass("woocommerce-error"),
		currentModel.find(".sa-message").append(o.message),
		currentModel.find(".sa-message").addClass("woocommerce-message"),
		currentModel.show(), 
		currentModel.find(".smsalert_validate_field").show(),
		sa_otp_timer(currentModel,otp_resend_timer),
		counterRunning=true,
		((typeof success_cb == "function") ? success_cb(o) : "" )
		):
		(
		currentModel.find(".smsalert_validate_field").hide(),
		currentModel.find(".sa-message").empty(),
		currentModel.find(".sa-message").append(o.message),
		currentModel.find(".sa-message").addClass("woocommerce-error"),
		currentModel.show(),
		//(cur_btn.is("input") ? cur_btn.val(prev_btn_text).attr("disabled",false) : cur_btn.text(prev_btn_text).attr("disabled",false))
		(cur_btn.is("input") ? cur_btn.val(prev_btn_text).attr("disabled",false) : cur_btn.removeClass('button--loading').attr("disabled",false))
		)

		},
		error:function(o,e,m)
		{
			cur_btn.val(prev_btn_text).attr("disabled",false);
			cur_btn.removeClass('check').attr("disabled",false);
			((typeof failure_cb == "function") ? failure_cb(o) : "" )
		}
	});	   
	return false;
}

function sa_validateOTP(obj,action_url,data_obj,callback)
{
	$sa  =jQuery;
	var current_btn = $sa(obj);
	current_btn.attr("disabled",true);
	var current_form = $sa(obj).parents("form");
	var wpml_lang 		= (typeof smsalert_wpml !=  'undefined' && smsalert_wpml['lang']) ? smsalert_wpml['lang'] : "";			
	$sa.ajax({
		//url:"'.site_url().'/?option=smsalert-validate-otp-form",
		url:action_url+"&lang="+wpml_lang,
		type:"POST",
		//data:current_form.serialize(),
		data:data_obj,
		crossDomain:!0,
		dataType:"json",
		success:function(o){("success"==o.result && o.message=="OTP Validated Successfully.")?
		(
			current_form.find('.smsalertModal').hide(),
			((typeof callback == "function") ? callback() : "" )
		):
		(
		current_btn.attr("disabled",false),
		current_form.find(".sa-message").empty().addClass("woocommerce-error"),
		current_form.find(".sa-message").append(o.message),
		current_form.find(".sa-message").removeClass("woocommerce-message"),
		current_form.find(".otp_input").focus())
		},
		error:function(o,e,m)
		{
			alert("error found here");
		}
	});
}

function sa_validateBlockOTP(obj,action_url,data_obj,callback)
{
	$sa  =jQuery;
	var current_btn = $sa(obj);
	current_btn.attr("disabled",true);
	var current_form = $sa(obj).parents(".smsalertModal");
	var wpml_lang 		= (typeof smsalert_wpml !=  'undefined' && smsalert_wpml['lang']) ? smsalert_wpml['lang'] : "";	
	
	$sa.ajax({
		//url:"'.site_url().'/?option=smsalert-validate-otp-form",
		url:action_url+"&lang="+wpml_lang,
		type:"POST",
		//data:current_form.serialize(),
		data:data_obj,
		crossDomain:!0,
		dataType:"json",
		success:function(o){("success"==o.result && o.message=="OTP Validated Successfully.")?
		(
			current_form.hide(),
			((typeof callback == "function") ? callback() : "" )
		):
		(
		current_btn.attr("disabled",false),
		current_form.find(".sa-message").empty().addClass("woocommerce-error"),
		current_form.find(".sa-message").append(o.message),
		current_form.find(".sa-message").removeClass("woocommerce-message"),
		current_form.find(".otp_input").focus())
		},
		error:function(o,e,m)
		{
			alert("error found here");
		}
	});
}

function digitGroup(obj,e)
{
	jQuery(obj).attr("maxlength", 1);
	var parent = jQuery(jQuery(obj).parent());
	if(e.keyCode === 8 || e.keyCode === 37) {
		var prev = parent.find("input#" + jQuery(obj).data("previous"));
		if(prev.length) {
			jQuery(prev).select();
		}
	} else if((e.keyCode >= 48 && e.keyCode <= 57) || (e.keyCode >= 65 && e.keyCode <= 90) || (e.keyCode >= 96 && e.keyCode <= 105) || e.keyCode === 39) {
		var next = parent.find("input#" + jQuery(obj).data("next"));
		if(next.length) {
			jQuery(next).select();
		} 
	}
}

jQuery(document).on("change",".smsalertModal .otp-number",function(e) {
	var otp_length 	= 4;
	var txtData 	= [];
	var parent 		= jQuery(this).parents(".smsalertModal");
	parent.find(".otp-number").each(function() {
		var otp_number = jQuery(this).val();
		txtData.push(otp_number);
	});
	parent.find(".otp_input").val(txtData.join(""));
	enableValidateBtn(parent.find(".otp_input"),otp_length);
	e.preventDefault();
});